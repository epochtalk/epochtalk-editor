<html>
<head>
  <title>EpochTalk Editor Example</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/medium-editor.css"> <!-- Core -->
  <link rel="stylesheet" href="css/themes/mani.css" id="medium-editor-theme">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
</head>
<body>
  <!-- Navigation -->
  <div class="ee-nav-container clearfix">
    <div class="pull-left">
      <div id="ee-medium-btn-list" class="ee-medium-buttons">
        <button onclick="editableCommand('bold');">
          <i class="fa fa-bold"></i>
        </button>
         <button onclick="editableCommand('italic');">
          <i class="fa fa-italic"></i>
        </button>
        <button onclick="editableCommand('underline');">
          <i class="fa fa-underline"></i>
        </button>
        <button onclick="editableCommand('anchor');">
          <i class="fa fa-link"></i>
        </button>
        <button onclick="editableCommand('append-h3');">
          <b>H1</b>
        </button>
        <button onclick="editableCommand('append-h4');">
          <b>H2</b>
        </button>
        <button onclick="editableCommand('append-blockquote');">
          <i class="fa fa-quote-right"></i>
        </button>
        <button onclick="editableCommand('subscript');">
          <i class="fa fa-subscript"></i>
        </button>
        <button onclick="editableCommand('superscript');">
          <i class="fa fa-superscript"></i>
        </button>
        <button onclick="editableCommand('strikethrough');">
          <strike>A</strike>
        </button>
        <button onclick="editableCommand('insertunorderedlist');">
          <i class="fa fa-list-ul"></i>
        </button>
        <button onclick="editableCommand('insertorderedlist');">
          <i class="fa fa-list-ol"></i>
        </button>
      </div>
      <div id="ee-bbcode-btn-list" class="ee-medium-buttons ee-hide">
        <button onmousedown="bbcodeCommand('[b]', '[/b]');">
          <i class="fa fa-bold"></i>
        </button>
         <button onmousedown="bbcodeCommand('[i]', '[/i]');">
          <i class="fa fa-italic"></i>
        </button>
        <button onmousedown="bbcodeCommand('[u]', '[/u]');">
          <i class="fa fa-underline"></i>
        </button>
        <button onmousedown="bbcodeCommand('[url]', '[/url]');">
          <i class="fa fa-link"></i>
        </button>
        <button onmousedown="bbcodeCommand('[size=20pt]', '[/size]');">
          <b>H1</b>
        </button>
        <button onmousedown="bbcodeCommand('[size=15pt]', '[/size]');">
          <b>H2</b>
        </button>
        <button onmousedown="bbcodeCommand('[quote]', '[/quote]');">
          <i class="fa fa-quote-right"></i>
        </button>
        <button onmousedown="bbcodeCommand('[sub]', '[/sub]');">
          <i class="fa fa-subscript"></i>
        </button>
        <button onmousedown="bbcodeCommand('[sup]', '[/sup]');">
          <i class="fa fa-superscript"></i>
        </button>
        <button onmousedown="bbcodeCommand('[s]', '[/s]');">
          <strike>A</strike>
        </button>
        <button onmousedown="bbcodeCommand('[ul]', '[/ul]');">
          <i class="fa fa-list-ul"></i>
        </button>
        <button onmousedown="bbcodeCommand('[ol]', '[/ol]');">
          <i class="fa fa-list-ol"></i>
        </button>
      </div>
    </div>
    <div class="pull-right">
      <select name="editor-select" id="editor-select">
        <option value="medium">Medium</option>
        <option value="bbcode">BBCode</option>
      </select>
    </div>
  </div>

  <div class="ee-main-container">
    <!-- Medium Editor -->
    <div id="medium-editor-container" class="ee-editor-container">
      <div id="medium-editor" class="editable ee-medium-editor" contenteditable="true" data-placeholder="Type your text" data-medium-element="true">
        Slow-carb lomo next level, Thundercats banjo High Life Echo Park roof party Intelligentsia gluten-free locavore Shoreditch Portland master cleanse skateboard. Leggings Shoreditch vinyl chambray tote bag, kitsch meggings fixie. Mumblecore deep v Truffaut pour-over Helvetica. Fixie artisan XOXO Pinterest narwhal High Life, single-origin coffee Etsy sartorial distillery bespoke butcher trust fund Pitchfork. Raw denim quinoa pickled, cardigan PBR cred butcher McSweeney's vegan salvia chillwave Helvetica. Schlitz small batch Truffaut you probably haven't heard of them, kogi street art stumptown lomo selvage jean shorts wolf post-ironic. Bushwick messenger bag yr Marfa chia.
      </div>
    </div>

    <!-- BBCode Editor -->
    <div id="bbcode-editor-container" class="ee-editor-container ee-hide-editor">
      <div class="ee-split-container">
        <div class="ee-half-column">
          <div id="bbcode-editor" class="ee-bbcode-editor" contenteditable="true" onkeyup="processBBCode();"></div>
        </div>
        <div class="ee-half-column">
          <div id="bbcode-preview" class="ee-bbcode-preview"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS!!! -->
  <script src="js/medium-editor.js"></script>
  <script src="js/xbbcode.js"></script>
  <script>
    // editor switcher
    var editorSelect = document.getElementById('editor-select');
    editorSelect.addEventListener("change", function() {
      // get selected option
      var selectedIndex = editorSelect.options.selectedIndex;
      var selectedOption = editorSelect.options[selectedIndex];
      var editorValue = selectedOption.value;

      // Gets div containing each editors buttons
      var bbcodeBtnList = document.getElementById('ee-bbcode-btn-list');
      var mediumBtnList = document.getElementById('ee-medium-btn-list');
      var mediumToolBar = document.getElementById('medium-editor-toolbar-1');

      // switch editor based on value
      if (editorValue === 'bbcode') {
        mediumBtnList.className='ee-medium-buttons ee-hide';
        bbcodeBtnList.className='ee-medium-buttons ee-show';
        mediumToolBar.style.display = 'none';

        var bbcodeContainer = document.getElementById('bbcode-editor-container');
        bbcodeContainer.className += ' ee-show-editor';
        bbcodeContainer.className = 
          bbcodeContainer.className.replace( /(?:^|\s)ee-hide-editor(?!\S)/g , '' );

        var bbcodeContainer = document.getElementById('medium-editor-container');
        bbcodeContainer.className += ' ee-hide-editor';
        bbcodeContainer.className = 
          bbcodeContainer.className.replace( /(?:^|\s)ee-show-editor(?!\S)/g , '' );
      }
      else {
        bbcodeBtnList.className='ee-medium-buttons ee-hide';
        mediumBtnList.className='ee-medium-buttons ee-show';
        mediumToolBar.style.display = 'block';

        var bbcodeContainer = document.getElementById('medium-editor-container');
        bbcodeContainer.className += ' ee-show-editor';
        bbcodeContainer.className = 
          bbcodeContainer.className.replace( /(?:^|\s)ee-hide-editor(?!\S)/g , '' );

        var bbcodeContainer = document.getElementById('bbcode-editor-container');
        bbcodeContainer.className += ' ee-hide-editor';
        bbcodeContainer.className = 
          bbcodeContainer.className.replace( /(?:^|\s)ee-show-editor(?!\S)/g , '' );
      }
    });

    // Medium Editor
    var editor = new MediumEditor('.editable', {
        buttonLabels: 'fontawesome',
        buttons: ['bold', 'italic', 'underline', 'anchor', 'header1', 'header2', 'quote', 'superscript', 'subscript', 'strikethrough', 'unorderedlist', 'orderedlist'],
        targetBlank: true
    });

    // bind to Medium Editor's input event
    window.addEventListener('load', function() {
      document.getElementById('medium-editor').addEventListener('input', function() {
        var text = document.getElementById('medium-editor').innerHTML;
        document.getElementById('bbcode-preview').innerHTML = text;
        document.getElementById('bbcode-editor').innerHTML = text;
      });
    });

    // BBCode Editor
    function processBBCode() {
      var code = document.getElementById("bbcode-editor").innerHTML;
      var result = XBBCODE.process({text: code});
      document.getElementById('bbcode-preview').innerHTML = result.html;
      document.getElementById('medium-editor').innerHTML = result.html;
    }

    // Commands for getting/setting caret position
    function setSelectionRange(element, start, end) {
      var rng = document.createRange();
      var sel = getSelection();
      var n;
      var o = 0;
      var tw = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, null);
      while (n = tw.nextNode()) {
        o += n.nodeValue.length;
        if (o > start) {
          rng.setStart(n, n.nodeValue.length + start - o);
          start = Infinity;
        }
        if (o >= end) {
          rng.setEnd(n, n.nodeValue.length + end - o);
          break;
        }
      }
      sel.removeAllRanges();
      sel.addRange(rng);
    }

    function setCaret(element, index) {
      setSelectionRange(element, index, index);
    }

    function getCaretPosition(element) {
      var ie = typeof document.selection != 'undefined' && document.selection.type != 'Control';
      var w3 = typeof window.getSelection != 'undefined';
      var caretOffset = 0;
      if (w3) {
        var range = window.getSelection().getRangeAt(0);
        var preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(element);
        preCaretRange.setEnd(range.endContainer, range.endOffset);
        caretOffset = preCaretRange.toString().length;
      } else if (ie) {
        var textRange = document.selection.createRange();
        var preCaretTextRange = document.body.createTextRange();
        preCaretTextRange.moveToElementText(element);
        preCaretTextRange.setEndPoint("EndToEnd", textRange);
        caretOffset = preCaretTextRange.text.length;
      }
      return caretOffset;
    }

    // static editor buttons commands
    function editableCommand(command, parameter) { 
      editor.execAction(command, parameter);
    }

    function bbcodeCommand(open, close) {
      // get selection
      var text, selection;
      if (document.selection) { selection = document.selection.createRange().text; }
      else { selection = window.getSelection(); }

      // prepend
      text = selection.toString();
      text = open + text + close;

      // append text
      var ctl = document.getElementById('bbcode-editor');
      if (selection.rangeCount) {
        range = selection.getRangeAt(0);
        range.deleteContents();
        var textNode = document.createTextNode(text);
        range.insertNode(textNode);
        processBBCode();

        // Update caret position
        ctl = document.getElementById('bbcode-editor');
        setCaret(ctl, Number(getCaretPosition(ctl)) + open.length);
      }
    }
  </script>
</body>
</html>